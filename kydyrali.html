<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aktau Connect</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="module" src="https://cdn.jsdelivr.net/npm/heroicons@2.1.1/24/outline/index.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* –ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å */
        :root {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
        }
        
        /* Dark Mode Styles */
        .dark-mode {
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-white { background-color: var(--bg-card); }
        .bg-gray-100 { background-color: var(--bg-body); }
        .text-gray-700 { color: var(--text-secondary); }
        .text-gray-600 { color: var(--text-secondary); }
        
        .page { display: none; }
        .page.active { display: block; }
        .service-button { transition: all 0.2s ease-in-out; }
        .service-button:active { transform: scale(0.95); background-color: #f0f0f0; }

        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        #loading-spinner {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .dark-mode #loading-spinner { background: rgba(17, 24, 39, 0.8); }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π Toast (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ) */
        #toast-notification {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500;
            z-index: 10000; transition: bottom 0.5s ease-in-out; max-width: 90%; text-align: center;
        }
        #toast-notification.show { bottom: 30px; }
        #toast-notification.success { background-color: #28a745; }
        #toast-notification.error { background-color: #dc3545; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ */
        .chat-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .user-message {
            background-color: #3b82f6; /* Blue */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }
        .gemini-message {
            background-color: var(--bg-card);
            border: 1px solid #e5e7eb;
            color: var(--text-primary);
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }
        .dark-mode .gemini-message {
            background-color: #1f2937;
            border: 1px solid #374151;
            color: #f9fafb;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (Chat/Alerts) */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
        }
        .modal-overlay.open {
            display: flex;
        }
        .modal-content {
            background: var(--bg-card);
            color: var(--text-primary);
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è Canvas */
        #game-canvas {
            border: 1px solid var(--text-secondary);
            background-color: #f0f9ff;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }
        /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (NEW) */
        #main-header-title {
            flex-grow: 1; 
            text-align: center;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –±–∞–¥–∂–µ–π */
        .badge-icon {
            filter: grayscale(100%);
            transition: filter 0.3s ease-in-out;
            cursor: help;
        }
        .badge-icon.active {
            filter: grayscale(0%);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-spinner">
        <div class="spinner"></div>
    </div>

    <div id="auth-view" class="page min-h-screen bg-white p-6">
        <div class="max-w-md mx-auto">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-8" data-lang-key="app_title">Aktau Connect</h1>
            
            <form id="login-form" class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4" data-lang-key="login_title">–í—Ö–æ–¥</h2>
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700" data-lang-key="email">Email</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                </div>
                <div class="mb-4">
                    <label for="login-password" class="block text-sm font-medium text-gray-700" data-lang-key="password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-150" data-lang-key="login_button">–í–æ–π—Ç–∏</button>
            </form>

            <form id="register-form" class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4" data-lang-key="register_title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <div class="mb-4">
                    <label for="register-nickname" class="block text-sm font-medium text-gray-700" data-lang-key="nickname">–í–∞—à –ù–∏–∫–Ω–µ–π–º (–¥–ª—è –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏)</label>
                    <input type="text" id="register-nickname" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                </div>
                <div class="mb-4">
                    <label for="register-microdistrict" class="block text-sm font-medium text-gray-700" data-lang-key="microdistrict">–í–∞—à –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω</label>
                    <input type="text" id="register-microdistrict" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white" placeholder="–ù–∞–ø—Ä: 14">
                </div>
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-700" data-lang-key="email">Email</label>
                    <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                </div>
                <div class="mb-4">
                    <label for="register-password" class="block text-sm font-medium text-gray-700" data-lang-key="password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700 transition duration-150" data-lang-key="register_button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </form>
            
            <div class="text-center mt-6">
                <button id="lang-toggle-auth" class="text-blue-600 font-medium">“ö–∞–∑–∞“õ—à–∞</button>
            </div>
        </div>
    </div>

    <div id="main-view" class="page max-w-md mx-auto min-h-screen shadow-lg">
        <header class="p-4 bg-white border-b sticky top-0 z-10">
            <div class="flex justify-between items-center mb-4">
                <button id="settings-button-main" class="nav-button p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition" data-target="settings-view" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-blue-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.008 1.132-1.008h2.548c.572 0 1.042.466 1.132 1.008l.698 4.186c.24.148.47.31.688.48l3.96-1.592c.504-.202 1.066.148 1.268.652l1.272 2.182c.202.504-.148 1.066-.652 1.268l-3.96 1.592a6.04 6.04 0 0 1 0 .96l3.96 1.592c.504.202.854.764.652 1.268l-1.272 2.182c-.202.504-.764.854-1.268.652l-3.96-1.592a5.996 5.996 0 0 1-.688.48l-.698-4.186c-.09.542-.56 1.008-1.132-1.008h-2.548c-.572 0-1.042-.466-1.132-1.008l-.698-4.186a5.996 5.996 0 0 1-.688-.48l-3.96 1.592c-.504.202-1.066-.148-1.268-.652l-1.272-2.182c-.202-.504.148-1.066.652-1.268l3.96-1.592c.218-.17.448-.332.688-.48l.698-4.186ZM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                    </svg>
                </button>
                
                <h1 id="main-header-title" class="text-2xl font-bold text-blue-600" data-lang-key="app_title">Aktau Connect</h1>

                <button id="open-chat-modal" class="p-2 rounded-full bg-purple-100 hover:bg-purple-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-purple-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM13.875 9.75a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM18.75 9.75a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487c.466-.466 1.22-.466 1.686 0l2.642 2.642c.466.466.466 1.22 0 1.686L18.06 13.5l1.69 1.69c.466.466.466 1.22 0 1.686l-2.642 2.642c-.466.466-1.22.466-1.686 0l-2.642-2.642-1.69 1.69c-.466.466-1.22.466-1.686 0l-2.642-2.642c-.466-.466-.466-1.22 0-1.686L5.94 13.5l-1.69-1.69c-.466-.466-.466-1.22 0-1.686l2.642-2.642c.466-.466 1.22-.466 1.686 0l2.642 2.642Z" />
                    </svg>
                </button>
            </div>
            
            <div class="bg-gradient-to-br from-blue-600 to-blue-700 text-white p-4 rounded-lg shadow-lg mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <span id="profile-nickname-main" class="font-bold text-lg">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        <div id="profile-level-main" class="text-sm opacity-90" data-lang-key="level">–£—Ä–æ–≤–µ–Ω—å: –ù–æ–≤–∏—á–æ–∫</div>
                    </div>
                    <div class="text-right">
                        <span id="profile-points-main" class="font-bold text-2xl">0</span>
                        <div class="text-sm opacity-90" data-lang-key="points">–ë–∞–ª–ª–æ–≤</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-4 bg-gray-100">
            <div class="grid grid-cols-3 gap-4">
                
                <button data-target="complaint-view" class="nav-button service-button bg-white dark:bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center aspect-square shadow-md hover:shadow-lg hover:-translate-y-1 border border-gray-200 dark:border-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-red-500 mb-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                    <span class="text-xs font-medium text-center text-gray-700 dark:text-gray-300" data-lang-key="menu_complaint">–ü–æ–¥–∞—Ç—å –∂–∞–ª–æ–±—É</span>
                </button>

                <button data-target="city-indicators-view" class="nav-button service-button bg-white dark:bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center aspect-square shadow-md hover:shadow-lg hover:-translate-y-1 border border-gray-200 dark:border-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-cyan-500 mb-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5a1.5 1.5 0 0 1 3 0V18a1.5 1.5 0 0 1-3 0v-4.5ZM9 13.5a1.5 1.5 0 0 1 3 0V20.25a1.5 1.5 0 0 1-3 0V13.5ZM15 10.5a1.5 1.5 0 0 1 3 0V20.25a1.5 1.5 0 0 1-3 0V10.5ZM18 1.5V5.25a1.5 1.5 0 0 0 1.5 1.5H21a.75.75 0 0 1 0 1.5h-1.5a1.5 1.5 0 0 0-1.5 1.5v3.75m-9-9v13.5M3 19.5V18a1.5 1.5 0 0 1 1.5-1.5h1.5M10.5 19.5v-13.5" />
                    </svg>
                    <span class="text-xs font-medium text-center text-gray-700 dark:text-gray-300" data-lang-key="menu_indicators">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</span>
                </button>

                <button data-target="profile-view" class="nav-button service-button bg-white dark:bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center aspect-square shadow-md hover:shadow-lg hover:-translate-y-1 border border-gray-200 dark:border-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-blue-500 mb-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                    </svg>
                    <span class="text-xs font-medium text-center text-gray-700 dark:text-gray-300" data-lang-key="menu_profile">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                </button>
                
                <button data-target="game-view" class="nav-button service-button bg-white dark:bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center aspect-square shadow-md hover:shadow-lg hover:-translate-y-1 border border-gray-200 dark:border-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-pink-500 mb-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3.004V18.75a2.25 2.25 0 0 1-2.25 2.25H7.5a2.25 2.25 0 0 1-2.25-2.25V8.25a3 3 0 0 1 3-3.004H15.75ZM15.75 5.25h-6.75m6.75 0a.75.75 0 0 1 .75 .75v.75m-7.5-.75a.75.75 0 0 0-.75 .75v.75M13.5 12h-3m3 3h-3" />
                    </svg>
                    <span class="text-xs font-medium text-center text-gray-700 dark:text-gray-300" data-lang-key="menu_game">–ú–∏–Ω–∏-–∏–≥—Ä–∞</span>
                </button>

                <button data-target="leaderboard-view" class="nav-button service-button bg-white dark:bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center aspect-square shadow-md hover:shadow-lg hover:-translate-y-1 border border-gray-200 dark:border-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-yellow-600 mb-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25m0 0h6.75m-6.75 0 3.09-3.75m-6.75 3.75-.9-3.75M8.25 16.5H4.5V21h3.75M16.5 16.5h-3.75V21h3.75M16.5 12h-3.75V16.5h3.75V12Z" />
                    </svg>
                    <span class="text-xs font-medium text-center text-gray-700 dark:text-gray-300" data-lang-key="menu_leaderboard">–†–µ–π—Ç–∏–Ω–≥</span>
                </button>
                
                <button data-target="community-view" class="nav-button service-button bg-white dark:bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center aspect-square shadow-md hover:shadow-lg hover:-translate-y-1 border border-gray-200 dark:border-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-green-500 mb-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.5c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5ZM8.25 19.5c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5ZM4.5 14.25c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5ZM19.5 14.25c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 0 0 9-9c0-4.048-2.617-7.462-6.524-8.583C15.8 2.9 14.07 2.25 12 2.25a9 9 0 0 0-9 9c0 4.048 2.617 7.462 6.524 8.583C8.2 21.6 9.93 22.25 12 22.25Z" />
                    </svg>
                    <span class="text-xs font-medium text-center text-gray-700 dark:text-gray-300" data-lang-key="menu_community">–°–æ–æ–±—â–µ—Å—Ç–≤–æ</span>
                </button>
            </div>
            
            <div class="mt-6">
                <h2 class="text-lg font-semibold mb-2" data-lang-key="menu_gov_services_title">E-“ö—ã–∑–º–µ—Ç—Ç–µ—Ä (–£—Å–ª—É–≥–∏ GovTech)</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button data-target="gov-services-view" class="nav-button service-button bg-white dark:bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center aspect-square shadow-md hover:shadow-lg hover:-translate-y-1 border border-gray-200 dark:border-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-indigo-500 mb-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25h4.5M3 7.5h15m-14.718-2.585a2.25 2.25 0 0 0-2.316 2.316l-3 1.25a2.25 2.25 0 0 0-2.184 0l-3-1.25a2.25 2.25 0 0 0-2.316-2.316h-.75" />
                        </svg>
                        <span class="text-xs font-medium text-center text-gray-700 dark:text-gray-300" data-lang-key="menu_gov_services">GovTech</span>
                    </button>
                    <button data-target="community-view" id="create-event-button" class="service-button bg-white dark:bg-gray-800 rounded-xl p-4 flex flex-col items-center justify-center aspect-square shadow-md hover:shadow-lg hover:-translate-y-1 border border-gray-200 dark:border-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-yellow-500 mb-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        <span class="text-xs font-medium text-center text-gray-700 dark:text-gray-300" data-lang-key="menu_create_event">–°–æ–∑–¥–∞—Ç—å –ò–≤–µ–Ω—Ç</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="complaint-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-10">
            <button class="nav-button" data-target="main-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="menu_complaint">–ü–æ–¥–∞—Ç—å –∂–∞–ª–æ–±—É</h1>
        </header>
        
        <form id="complaint-form" class="p-4 space-y-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3" data-lang-key="complaint_details">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã</h2>
                <div>
                    <label for="complaint-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="complaint_category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="complaint-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                        <option value="broken_road" data-lang-key="cat_road">–†–∞–∑–±–∏—Ç–∞—è –¥–æ—Ä–æ–≥–∞</option>
                        <option value="trash" data-lang-key="cat_trash">–ú—É—Å–æ—Ä</option>
                        <option value="stray_animals" data-lang-key="cat_animals">–ë—Ä–æ–¥—è—á–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–µ</option>
                        <option value="no_lighting" data-lang-key="cat_light">–ù–µ—Ç –æ—Å–≤–µ—â–µ–Ω–∏—è</option>
                        <option value="other" data-lang-key="cat_other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>

                <div class="mt-4">
                    <label for="complaint-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="complaint_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="complaint-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 dark:text-white" placeholder="–ö—Ä–∞—Ç–∫–æ –æ –ø—Ä–æ–±–ª–µ–º–µ...">
                </div>
                
                <div class="mt-4">
                    <label for="complaint-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="complaint_desc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="complaint-description" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 dark:text-white" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3" data-lang-key="complaint_attachments">–§–æ—Ç–æ (–°—Å—ã–ª–∫–∞/–°–∏–ø–∞—Ç—Ç–∞–º–∞) –∏ –ú–µ—Å—Ç–æ</h2>
                <div>
                    <label for="complaint-photo-link" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="complaint_photo_link_label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" id="complaint-photo-link" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 dark:text-white" placeholder="https://i.imgur.com/example.jpg –∏–ª–∏ '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ –º–µ—Å—Ç–µ'">
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-lang-key="complaint_location">–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                    <button type="button" id="get-current-location" class="mt-2 w-full bg-yellow-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-yellow-600 transition duration-150">
                        <span id="location-status" data-lang-key="get_location">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span>
                    </button>
                    <input type="hidden" id="complaint-location" required>
                    <div id="offline-draft-message" class="mt-2 text-sm text-yellow-600 dark:text-yellow-400 hidden"></div>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-150" data-lang-key="complaint_submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å (+10 –±–∞–ª–ª–æ–≤)</button>
        </form>
    </div>

    <div id="city-indicators-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-20">
            <button class="nav-button" data-target="main-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="menu_indicators">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ì–æ—Ä–æ–¥–∞</h1>
        </header>
        
        <div class="p-4 space-y-4">
            <h2 class="text-lg font-semibold border-b pb-2" data-lang-key="indicators_live_data">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ò–º–∏—Ç–∞—Ü–∏—è)</h2>
            <div id="indicators-data" class="grid grid-cols-2 gap-4">
                
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700 text-center">
                    <p class="text-sm text-gray-500" data-lang-key="indicator_air">–ö–∞—á–µ—Å—Ç–≤–æ –í–æ–∑–¥—É—Ö–∞</p>
                    <p class="text-2xl font-bold text-green-600 mt-1">–•–æ—Ä–æ—à–æ</p>
                    <p class="text-xs text-gray-400">AQI: 35</p>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700 text-center">
                    <p class="text-sm text-gray-500" data-lang-key="indicator_weather">–ü–æ–≥–æ–¥–∞</p>
                    <p class="text-2xl font-bold text-blue-600 mt-1">+12¬∞C</p>
                    <p class="text-xs text-gray-400">–û–±–ª–∞—á–Ω–æ, –±–µ–∑ –æ—Å–∞–¥–∫–æ–≤</p>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700 text-center">
                    <p class="text-sm text-gray-500" data-lang-key="indicator_traffic">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –î–æ—Ä–æ–≥</p>
                    <p class="text-2xl font-bold text-yellow-600 mt-1">–°—Ä–µ–¥–Ω—è—è</p>
                    <p class="text-xs text-gray-400">3/10 –±–∞–ª–ª–æ–≤</p>
                </div>

                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700 text-center">
                    <p class="text-sm text-gray-500" data-lang-key="indicator_complaints">–ê–∫—Ç–∏–≤–Ω—ã–µ –ñ–∞–ª–æ–±—ã</p>
                    <p id="active-complaints-count" class="text-2xl font-bold text-red-600 mt-1">...</p>
                    <p class="text-xs text-gray-400">–ñ–∞–ª–æ–± –≤ —Ä–∞–±–æ—Ç–µ</p>
                </div>
            </div>
            
            <h2 class="text-lg font-semibold border-b pb-2 pt-4" data-lang-key="indicators_geo_data">–°–æ–±—ã—Ç–∏—è –∏ –ú–µ—Å—Ç–∞</h2>
            <p class="text-gray-600 dark:text-gray-400 text-sm" data-lang-key="indicators_geo_desc">
                –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É –∏–ª–∏ —Å–ø–∏—Å–æ–∫ –≥–µ–æ-–¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ —Ä–∞–Ω–µ–µ. –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ –∫–ª—é—á–µ–≤—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤.
            </p>
            
            <div id="map-events-feed" class="space-y-3">
                <p class="text-gray-500" data-lang-key="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π...</p>
            </div>
        </div>
    </div>
    
    <div id="profile-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-10">
            <button class="nav-button" data-target="main-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="menu_profile">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h1>
        </header>
        
        <div class="p-4 space-y-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-2" data-lang-key="profile_hero_passport">–ü–∞—Å–ø–æ—Ä—Ç –ì–µ—Ä–æ—è</h2>
                <div class="space-y-2 text-sm">
                    <p><strong>UserID:</strong> <span id="profile-userid" class="text-gray-600 dark:text-gray-400 break-all"></span></p>
                    <p><strong>–ù–∏–∫–Ω–µ–π–º:</strong> <span id="profile-nickname" class="font-medium text-blue-600"></span></p>
                    <p><strong>Email:</strong> <span id="profile-email" class="font-medium"></span></p>
                    <p><strong>–ú–∏–∫—Ä–æ—Ä–∞–π–æ–Ω:</strong> <span id="profile-microdistrict" class="font-medium"></span></p>
                    <p><strong>–ë–∞–ª–ª—ã:</strong> <span id="profile-points" class="font-medium text-green-600"></span></p>
                    <p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> <span id="profile-level" class="font-medium"></span></p>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3" data-lang-key="profile_achievements_title">–ú–æ–∏ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
                <div id="achievement-badges" class="flex justify-around items-center space-x-2">
                    <div title="–ù–æ–≤–∏—á–æ–∫" data-points-required="0" class="badge-icon">
                        <span style="font-size: 32px;">üë∂</span>
                    </div>
                    <div title="–ü–æ–º–æ—â–Ω–∏–∫ (100+)" data-points-required="100" class="badge-icon">
                        <span style="font-size: 32px;">ü•â</span>
                    </div>
                    <div title="–ê–∫—Ç–∏–≤–∏—Å—Ç (500+)" data-points-required="500" class="badge-icon">
                        <span style="font-size: 32px;">ü•à</span>
                    </div>
                    <div title="–ì–µ—Ä–æ–π –ì–æ—Ä–æ–¥–∞ (1000+)" data-points-required="1000" class="badge-icon">
                        <span style="font-size: 32px;">üèÜ</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-4" data-lang-key="profile_my_complaints">–ú–æ–∏ –∂–∞–ª–æ–±—ã</h2>
                <div id="my-complaints-list" class="space-y-3 max-h-64 overflow-y-auto">
                    <p class="text-gray-500" data-lang-key="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
            
            <button id="logout-button" class="w-full bg-red-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-600 transition duration-150" data-lang-key="logout_button">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>
    </div>
    
    <div id="quiz-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-10">
            <button class="nav-button" data-target="main-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="menu_quiz">–≠–∫–æ-–ö–≤–∏–∑</h1>
        </header>
        
        <div class="p-4">
            <div id="quiz-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow border border-gray-200 dark:bg-gray-700">
                <p class="text-gray-500" data-lang-key="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>
    
    <div id="game-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-10">
            <button class="nav-button" data-target="main-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="menu_game">–ú–∏–Ω–∏-–∏–≥—Ä–∞: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ú—É—Å–æ—Ä–∞</h1>
        </header>
        
        <div class="p-4 text-center">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                <p id="game-info" class="text-lg font-semibold mb-2">–°—á–µ—Ç: 0 | –í—Ä–µ–º—è: 30</p>
                <canvas id="game-canvas" width="300" height="400" class="shadow-xl"></canvas>
                <button id="start-game-btn" class="mt-4 w-full bg-green-500 text-white py-2 rounded-md font-semibold hover:bg-green-600 transition duration-150">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (+50 –±–∞–ª–ª–æ–≤ –∑–∞ –ø–æ–±–µ–¥—É)</button>
            </div>
        </div>
    </div>

    <div id="leaderboard-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-10">
            <button class="nav-button" data-target="main-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="menu_leaderboard">–†–µ–π—Ç–∏–Ω–≥ –ê–∫—Ç–∏–≤–Ω—ã—Ö –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h1>
        </header>
        
        <div class="p-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">–¢–æ–ø-5 –ì–µ—Ä–æ–µ–≤ –ê–∫—Ç–∞—É</h2>
                <div id="leaderboard-list" class="space-y-3">
                    <p class="text-gray-500" data-lang-key="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
            </div>
        </div>
    </div>
    
    <div id="community-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-10">
            <button class="nav-button" data-target="main-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="menu_community">–°–æ–æ–±—â–µ—Å—Ç–≤–æ / –ì–µ—Ä–æ–∏ –ì–æ—Ä–æ–¥–∞</h1>
        </header>
        
        <div class="p-4 space-y-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3 text-pink-600" data-lang-key="community_volunteer_title">–í–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–∏–µ –î–≤–∏–∂–µ–Ω–∏—è</h2>
                <div class="flex justify-between items-center text-sm border-b pb-2 mb-2">
                    <span data-lang-key="community_active_member">–°–∞–º—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫:</span>
                    <span class="font-bold text-blue-600">–ê–ª–∏—è –ö. (14 –º–∫—Ä)</span>
                </div>
                
                <h3 class="font-semibold mt-4 mb-2" data-lang-key="community_popular_spots">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–µ—Å—Ç–∞ —É –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤:</h3>
                <div id="volunteer-spots-list" class="space-y-2 text-sm">
                    <p class="text-gray-500" data-lang-key="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
                
                <p class="text-gray-600 dark:text-gray-400 text-sm mt-3" data-lang-key="community_volunteer_desc">
                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–∏–º –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–∏–º –¥–≤–∏–∂–µ–Ω–∏—è–º! –ù–∞–±–∏—Ä–∞–π—Ç–µ –±–∞–ª–ª—ã –∑–∞ –ø–æ–º–æ—â—å –≥–æ—Ä–æ–¥—É –∏ —Å—Ç–∞–Ω—å—Ç–µ –ì–µ—Ä–æ–µ–º –ê–∫—Ç–∞—É.
                </p>
                <button class="mt-3 w-full bg-pink-500 text-white py-2 rounded-md font-semibold hover:bg-pink-600 transition duration-150" data-lang-key="community_join">
                    –£–∑–Ω–∞—Ç—å –æ –±–ª–∏–∂–∞–π—à–∏—Ö –∞–∫—Ü–∏—è—Ö
                </button>
            </div>
            
             <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3 text-yellow-600" data-lang-key="community_create_event_title">–°–æ–∑–¥–∞—Ç—å –í–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–∏–π –ò–≤–µ–Ω—Ç</h2>
                <form id="create-event-form" class="space-y-3">
                    <input type="text" id="event-title" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-yellow-500 bg-white dark:bg-gray-700 dark:text-white" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (–Ω–∞–ø—Ä. –≠–∫–æ-–°—É–±–±–æ—Ç–Ω–∏–∫)">
                    <input type="text" id="event-location-text" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-yellow-500 bg-white dark:bg-gray-700 dark:text-white" placeholder="–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä. –ü–∞—Ä–∫ '–ê–∫–±–æ—Ç–∞')">
                    <input type="date" id="event-date" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-yellow-500 bg-white dark:bg-gray-700 dark:text-white">
                    <button type="submit" class="w-full bg-yellow-500 text-white py-2 rounded-md font-semibold hover:bg-yellow-600 transition duration-150" data-lang-key="community_publish_event">
                        –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ò–≤–µ–Ω—Ç (+20 –±–∞–ª–ª–æ–≤)
                    </button>
                </form>
            </div>


            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3 text-yellow-600" data-lang-key="community_essay_title">–ú–∏–Ω–∏-—ç—Å—Å–µ: –ß—Ç–æ —è —Å–¥–µ–ª–∞–ª –¥–ª—è –º–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h2>
                
                <div id="essay-form-container" class="space-y-3">
                    <textarea id="my-essay-text" rows="5" class="w-full p-3 border border-gray-300 rounded-md focus:ring-yellow-500 bg-white dark:bg-gray-700 dark:text-white" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é, —á—Ç–æ–±—ã –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç—å –¥—Ä—É–≥–∏—Ö..."></textarea>
                    <button id="publish-essay-btn" class="w-full bg-yellow-500 text-white py-2 rounded-md font-semibold hover:bg-yellow-600 transition duration-150" data-lang-key="community_publish_essay">
                        –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é (+50 –±–∞–ª–ª–æ–≤)
                    </button>
                </div>

                <h3 class="font-semibold mt-4 mb-2" data-lang-key="community_latest_stories">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ò—Å—Ç–æ—Ä–∏–∏:</h3>
                <div id="latest-essays-list" class="space-y-3">
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-md">
                        <p class="text-sm italic text-gray-700 dark:text-gray-300">"–Ø –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª —Ä–∞–∑–¥–µ–ª—å–Ω—ã–π —Å–±–æ—Ä –º—É—Å–æ—Ä–∞ –≤–æ –¥–≤–æ—Ä–µ —Å–≤–æ–µ–≥–æ –¥–æ–º–∞, –∏ —Ç–µ–ø–µ—Ä—å –Ω–∞—à 15-–π –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω —Å—Ç–∞–ª —á–∏—â–µ!"</p>
                        <p class="text-xs font-semibold text-right mt-2 text-yellow-700 dark:text-yellow-300">‚Äî –î–∏–∞—Å (15 –º–∫—Ä)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="gov-services-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-10">
            <button class="nav-button" data-target="main-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="menu_gov_services">E-“ö—ã–∑–º–µ—Ç—Ç–µ—Ä / GovTech</h1>
        </header>
        
        <div class="p-4 space-y-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3 text-indigo-600" data-lang-key="gov_esenim_title">E-Senim (–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" data-lang-key="gov_esenim_desc">
                    –ë—ã—Å—Ç—Ä–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ —Ä–µ–±–µ–Ω–∫–∞ (–∏–º–∏—Ç–∞—Ü–∏—è).
                </p>
                <button class="w-full bg-indigo-500 text-white py-2 rounded-md font-semibold hover:bg-indigo-600 transition duration-150" data-lang-key="gov_esenim_button">
                    –û—Ñ–æ—Ä–º–∏—Ç—å QR-–¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                </button>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3 text-indigo-600" data-lang-key="gov_voting_title">–®–∞“ì—ã–Ω-–∞—É–¥–∞–Ω –î–∞—É—ã—Å—ã (–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ)</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" data-lang-key="gov_voting_desc">
                    –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞ –≤ –≤–∞—à–µ–º –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω–µ (–∏–º–∏—Ç–∞—Ü–∏—è).
                </p>
                <div class="space-y-2">
                    <p class="font-medium">1. –†–µ–º–æ–Ω—Ç –¥–æ—Ä–æ–≥ (14 –º–∫—Ä)</p>
                    <div class="flex justify-between text-sm">
                        <span>–ó–∞: 75%</span>
                        <span>–ü—Ä–æ—Ç–∏–≤: 25%</span>
                    </div>
                </div>
                <button class="w-full bg-gray-500 text-white py-2 rounded-md font-semibold mt-3" disabled data-lang-key="gov_voting_button">
                    –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å (–ò–º–∏—Ç–∞—Ü–∏—è)
                </button>
            </div>
        </div>
    </div>
    
    <div id="settings-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-10">
            <button class="nav-button" data-target="main-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="settings_title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        </header>
        
        <div class="p-4 space-y-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3" data-lang-key="settings_language">–Ø–∑—ã–∫ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h2>
                <button id="lang-toggle-settings" class="w-full bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 py-2 px-4 rounded-md font-semibold hover:bg-blue-200 transition duration-150">“ö–∞–∑–∞“õ—à–∞</button>
            </div>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold mb-3" data-lang-key="settings_theme">–¢–µ–º–∞</h2>
                <button id="theme-toggle" class="w-full bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-md font-semibold transition duration-150">
                    <span data-lang-key="theme_light">–°–≤–µ—Ç–ª–∞—è</span>
                </button>
            </div>
            
            <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg shadow border border-red-200 dark:border-red-700">
                 <h2 class="text-lg font-semibold mb-3 text-red-600">–°–ª—É–∂–µ–±–Ω—ã–π –≤—Ö–æ–¥ (–ê–¥–º–∏–Ω)</h2>
                 <button class="nav-button w-full bg-red-500 text-white py-2 rounded-md font-semibold hover:bg-red-600 transition duration-150" data-target="admin-view">
                    –ü–µ—Ä–µ–π—Ç–∏ –≤ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                 </button>
            </div>
        </div>
    </div>
    
    <div id="admin-view" class="page max-w-md mx-auto min-h-screen">
        <header class="bg-white dark:bg-gray-800 p-4 border-b flex items-center sticky top-0 z-10">
            <button class="nav-button" data-target="settings-view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold ml-4" data-lang-key="menu_admin">–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∞</h1>
        </header>
        
        <div class="p-4">
            <h2 class="text-lg font-semibold mb-4" data-lang-key="admin_all_complaints">–í—Å–µ –∂–∞–ª–æ–±—ã</h2>
            <div id="admin-complaints-list" class="space-y-4">
                <p class="text-gray-500" data-lang-key="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>

    <div id="chat-modal" class="modal-overlay" onclick="closeModal('chat-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center rounded-t-lg">
                <h2 class="text-xl font-semibold" data-lang-key="menu_chat">Smart Chat (AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç)</h2>
                <button onclick="closeModal('chat-modal')" class="text-white hover:opacity-75 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div id="chat-history" class="p-4 flex-1 overflow-y-auto space-y-2 bg-gray-100 dark:bg-gray-900">
                <div class="chat-bubble gemini-message">
                    <p data-lang-key="chat_intro_message">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø Smart Assistant –ê–∫—Ç–∞—É. –°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –æ –ø–æ–≥–æ–¥–µ, —Å–æ–±—ã—Ç–∏—è—Ö –∏–ª–∏ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö!</p>
                </div>
            </div>

            <form id="chat-form" class="bg-white dark:bg-gray-800 p-4 border-t">
                <div class="flex space-x-2">
                    <input type="text" id="chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                    <button type="submit" class="bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150" id="chat-submit-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0 1 21.485 12 59.77 59.77 0 0 1 3.27 20.876L5.999 12Zm0 0h7.5" />
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 80vh;">
            <div class="bg-red-600 text-white p-4 flex justify-between items-center rounded-t-lg">
                <h2 class="text-xl font-semibold" data-lang-key="alert_warn">–í–∞–∂–Ω–æ–µ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!</h2>
                <button onclick="closeModal('alert-modal')" class="text-white hover:opacity-75 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="alert-modal-content" class="p-4 overflow-y-auto space-y-4">
                <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg shadow-sm border border-red-200 dark:border-red-700">
                    <span class="text-xs font-semibold text-red-600 dark:text-red-300" data-lang-key="alert_warn">–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï</span>
                    <h3 class="text-lg font-bold mt-1 text-red-800 dark:text-red-100" data-lang-key="alert1_title">–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤–æ–¥—ã –≤ 15 –º–∫—Ä. (–°–µ–≥–æ–¥–Ω—è)</h3>
                    <p class="text-gray-700 dark:text-gray-300 text-sm" data-lang-key="alert1_desc">9 –Ω–æ—è–±—Ä—è —Å 10:00 –¥–æ 17:00 –≤ —Å–≤—è–∑–∏ —Å –ø–ª–∞–Ω–æ–≤—ã–º–∏ —Ä–∞–±–æ—Ç–∞–º–∏.</p>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow-sm border border-blue-200 dark:border-blue-700">
                    <span class="text-xs font-semibold text-blue-600 dark:text-blue-300" data-lang-key="alert_event">–°–û–ë–´–¢–ò–ï</span>
                    <h3 class="text-lg font-bold mt-1 text-blue-800 dark:text-blue-100" data-lang-key="alert2_title">–Ø—Ä–º–∞—Ä–∫–∞ –Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–æ–π (–í—ã—Ö–æ–¥–Ω—ã–µ)</h3>
                    <p class="text-gray-700 dark:text-gray-300 text-sm" data-lang-key="alert2_desc">–í —ç—Ç–∏ –≤—ã—Ö–æ–¥–Ω—ã–µ, 11-12 –Ω–æ—è–±—Ä—è, –ø—Ä–æ–π–¥–µ—Ç —è—Ä–º–∞—Ä–∫–∞ –º–µ—Å—Ç–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤.</p>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end">
                <button onclick="closeModal('alert-modal')" class="bg-red-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-600 transition">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="e-senim-modal" class="modal-overlay" onclick="closeModal('e-senim-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="bg-indigo-600 text-white p-4 flex justify-between items-center rounded-t-lg">
                <h2 class="text-xl font-semibold" data-lang-key="gov_esenim_title">E-Senim (QR-–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)</h2>
                <button onclick="closeModal('e-senim-modal')" class="text-white hover:opacity-75 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="e-senim-content" class="p-4 flex flex-col items-center justify-center">
                <p class="text-sm text-center mb-4" data-lang-key="esenim_qr_ready">–í–∞—à–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≥–æ—Ç–æ–≤–∞. –ü—Ä–µ–¥—ä—è–≤–∏—Ç–µ QR-–∫–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</p>
                <div id="e-senim-qr-code" class="p-4 bg-white border border-gray-200 rounded-lg shadow-inner">
                    <p class="text-center text-xs text-gray-400">QR-–∫–æ–¥...</p>
                </div>
                <p id="e-senim-id" class="mt-4 text-sm font-semibold text-gray-700 dark:text-gray-300"></p>
                <p class="text-xs text-red-500 mt-2">–ò–º–∏—Ç–∞—Ü–∏—è. ID —É–Ω–∏–∫–∞–ª–µ–Ω, –Ω–æ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ.</p>
            </div>
            <div class="p-4 border-t flex justify-end">
                <button onclick="closeModal('e-senim-modal')" class="bg-indigo-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-indigo-600 transition">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="toast-notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <script type="module">
        // --- 0. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE –ò GEMINI ---
        
        // Supabase (–ö–ª—é—á–∏ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞)
        const SUPABASE_URL = 'https://tavssoyxkytcmkkjyhvm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhdnNzb3l4a3l0Y21ra2p5aHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NzE3MzYsImV4cCI6MjA3ODI0NzczNn0.jDbyJdZLv4jqAK2KghwV46fffnNUYvT93iBWgxeXHiI';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Gemini API Configuration (Placeholder)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π URL –±–µ–∑ –≤–µ—Ä—Å–∏–∏ –ø—Ä–µ–≤—å—é, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å 404.
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=';
        const GEMINI_API_KEY = "AIzaSyCvIkOX2JH3PZSu0FlrnGiAZljPX92S5aE"; // –ö–ª—é—á —É–¥–∞–ª–µ–Ω —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

        // --- 1. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ò –£–¢–ò–õ–ò–¢–´ ---
        
        let currentUser = null;
        let userProfile = null;
        let currentLang = 'ru'; // 'ru' –∏–ª–∏ 'kz'
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        let chatHistory = []; 
        
        const AKTAU_COORDS = [43.65, 51.17]; // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ê–∫—Ç–∞—É (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏)
        const THEME_KEY = 'theme';
        const GAME_CANVAS_ID = 'game-canvas'; 
        
        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–±—ã—Ç–∏–π (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞—Ö –∏ –°–æ–æ–±—â–µ—Å—Ç–≤–µ)
        const MAP_DATA = [
            { id: 1, title: '–°—É–±–±–æ—Ç–Ω–∏–∫ –≤ 4 –º–∫—Ä.', description: '–≠–∫–æ-–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –ø–æ –æ—á–∏—Å—Ç–∫–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –≤–æ–∑–ª–µ –º–æ—Ä—è. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å!', type: 'initiative', date: '2025-11-15', location: { lat: 43.6669, lng: 51.1710 }, link: '#' },
            { id: 2, title: '–î—Ä–∞–º—Ç–µ–∞—Ç—Ä –∏–º. –ù. –ñ–∞–Ω—Ç—É—Ä–∏–Ω–∞', description: '–û—Å–Ω–æ–≤–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–Ω–∞—è –ø–ª–æ—â–∞–¥–∫–∞ –≥–æ—Ä–æ–¥–∞. –†–µ–ø–µ—Ä—Ç—É–∞—Ä –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ.', type: 'place', location: { lat: 43.6550, lng: 51.1578 }, link: 'https://dramteatr.kz/' },
            { id: 3, title: '–§–µ—Å—Ç–∏–≤–∞–ª—å –≤–æ–∑–¥—É—à–Ω—ã—Ö –∑–º–µ–µ–≤', description: '–ï–∂–µ–≥–æ–¥–Ω—ã–π —Ñ–µ—Å—Ç–∏–≤–∞–ª—å –Ω–∞ –ø–æ–±–µ—Ä–µ–∂—å–µ –ö–∞—Å–ø–∏—è.', type: 'event', date: '2025-11-20', location: { lat: 43.6580, lng: 51.1680 }, link: '#' },
            { id: 4, title: '–ü–∞—Ä–∫ "–ê–∫–±–æ—Ç–∞"', description: '–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è —Å—É–±–±–æ—Ç–Ω–∏–∫–æ–≤ –∏ –≤—Å—Ç—Ä–µ—á –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤.', type: 'initiative', location: { lat: 43.6600, lng: 51.1600 }, link: '#' },
            { id: 5, title: '–¶–µ–Ω—Ç—Ä –°–±–æ—Ä–∞ –í—Ç–æ—Ä—Å—ã—Ä—å—è', description: '–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è —ç–∫–æ-–∞–∫—Ü–∏–π.', type: 'initiative', location: { lat: 43.6500, lng: 51.1500 }, link: '#' },
        ];


        // –û–±—ä–µ–∫—Ç—ã DOM
        const pages = document.querySelectorAll('.page');
        const loadingSpinner = document.getElementById('loading-spinner');
        const toast = document.getElementById('toast-notification');

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        const showLoader = (show) => {
            loadingSpinner.style.display = show ? 'flex' : 'none';
        };

        // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è Toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        const showToast = (message, type = 'success') => {
            toast.textContent = message;
            toast.className = type; // 'success' –∏–ª–∏ 'error'
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };
        
        // --- –õ–û–ì–ò–ö–ê –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù (NEW) ---
        window.openModal = (id) => {
            document.getElementById(id).classList.add('open');
            if (id === 'chat-modal') {
                initChatModal();
            }
            if (id === 'alert-modal') {
                localStorage.setItem('hasSeenAlerts', 'true');
            }
        };

        window.closeModal = (id) => {
            document.getElementById(id).classList.remove('open');
        };

        // --- –õ–û–ì–ò–ö–ê –¢–ï–ú–´ ---
        
        const getThemeText = (key) => {
            if (currentLang === 'kz' && translations.kz[key]) {
                return translations.kz[key];
            }
            if (key === 'theme_light') return '–°–≤–µ—Ç–ª–∞—è';
            if (key === 'theme_dark') return '–¢–µ–º–Ω–∞—è';
            return key;
        }

        function applyTheme(theme) {
            currentTheme = theme;
            document.body.classList.toggle('dark-mode', theme === 'dark');
            localStorage.setItem(THEME_KEY, theme);
            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) {
                if (theme === 'dark') {
                    themeBtn.innerHTML = `<span data-lang-key="theme_dark">${getThemeText('theme_dark')}</span>`;
                    themeBtn.classList.remove('bg-gray-200');
                    themeBtn.classList.add('bg-blue-600', 'text-white');
                } else {
                    themeBtn.innerHTML = `<span data-lang-key="theme_light">${getThemeText('theme_light')}</span>`;
                    themeBtn.classList.remove('bg-blue-600', 'text-white');
                    themeBtn.classList.add('bg-gray-200');
                }
            }
        }
        
        // --- 2. –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø (RU/KZ) ---
        
        const translations = {
            'kz': {
                'app_title': 'Aktau Connect',
                'login_title': '–ö—ñ—Ä—É',
                'email': 'Email',
                'password': '“ö“±–ø–∏—è —Å”©–∑',
                'login_button': '–ö—ñ—Ä—É',
                'register_title': '–¢—ñ—Ä–∫–µ–ª—É',
                'nickname': '–õ–∞“õ–∞–ø –∞—Ç—ã“£—ã–∑',
                'microdistrict': '–´“õ—à–∞–º –∞—É–¥–∞–Ω—ã“£—ã–∑',
                'register_button': '–¢—ñ—Ä–∫–µ–ª—É',
                'level': '–î–µ“£–≥–µ–π',
                'points': '“∞–ø–∞–π',
                'menu_complaint': '–®–∞“ì—ã–º –±–µ—Ä—É',
                'menu_indicators': '–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–ª–∞—Ä', 
                'menu_profile': '–ú–µ–Ω—ñ“£ –ø—Ä–æ—Ñ–∏–ª—ñ–º',
                'menu_quiz': '–≠–∫–æ-–í–∏–∫—Ç–æ—Ä–∏–Ω–∞',
                'menu_game': '–ú–∏–Ω–∏-–æ–π—ã–Ω', 
                'menu_leaderboard': '–†–µ–π—Ç–∏–Ω–≥', 
                'menu_chat': 'Smart Chat (AI)', 
                'menu_community': '“ö–∞—É—ã–º–¥–∞—Å—Ç—ã“õ', 
                'menu_admin': '”ò–∫—ñ–º—à—ñ', 
                'menu_gov_services_title': 'E-“ö—ã–∑–º–µ—Ç—Ç–µ—Ä (GovTech)',
                'menu_gov_services': 'E-“ö—ã–∑–º–µ—Ç—Ç–µ—Ä',
                'menu_create_event': '–Ü—Å-—à–∞—Ä–∞ “õ“±—Ä—É',
                'complaint_details': '–ú”ô—Å–µ–ª–µ —Ç—É—Ä–∞–ª—ã',
                'complaint_attachments': '–§–æ—Ç–æ (–°—ñ–ª—Ç–µ–º–µ/–°–∏–ø–∞—Ç—Ç–∞–º–∞) –∂”ô–Ω–µ –æ—Ä—ã–Ω',
                'complaint_category': '–°–∞–Ω–∞—Ç',
                'complaint_title': '–¢–∞“õ—ã—Ä—ã–ø', 
                'complaint_photo_link_label': '–§–æ—Ç–æ—Å—É—Ä–µ—Ç–∫–µ —Å—ñ–ª—Ç–µ–º–µ –Ω–µ–º–µ—Å–µ —Å–∏–ø–∞—Ç—Ç–∞–º–∞',
                'cat_road': '–ë“±–∑—ã–ª“ì–∞–Ω –∂–æ–ª',
                'cat_trash': '“ö–æ“õ—ã—Å',
                'cat_animals': '“ö–∞“£“ì—ã–±–∞—Å –∂–∞–Ω—É–∞—Ä–ª–∞—Ä',
                'cat_light': '–ñ–∞—Ä—ã“õ –∂–æ“õ',
                'cat_other': '–ë–∞—Å“õ–∞',
                'complaint_desc': '–°–∏–ø–∞—Ç—Ç–∞–º–∞',
                'complaint_photo': '–§–æ—Ç–æ —Ç—ñ—Ä–∫–µ—É',
                'complaint_location': '–û—Ä—ã–Ω–¥—ã –±–µ–ª–≥—ñ–ª–µ“£—ñ–∑',
                'get_location': '–ú–µ–Ω—ñ“£ –æ—Ä–Ω—ã–º–¥—ã –∞–Ω—ã“õ—Ç–∞—É', 
                'complaint_submit': '–ñ—ñ–±–µ—Ä—É (+10 “±–ø–∞–π)',
                'indicators_live_data': '”®–∑–µ–∫—Ç—ñ –¥–µ—Ä–µ–∫—Ç–µ—Ä (–ò–º–∏—Ç–∞—Ü–∏—è)', 
                'indicator_air': '–ê—É–∞ –°–∞–ø–∞—Å—ã', 
                'indicator_weather': '–ê—É–∞ —Ä–∞–π—ã', 
                'indicator_traffic': '–ñ–æ–ª –ö–µ–ø—Ç–µ–ª—ñ—Å—ñ', 
                'indicator_complaints': '–ë–µ–ª—Å–µ–Ω–¥—ñ –®–∞“ì—ã–º–¥–∞—Ä', 
                'indicators_geo_data': '–û“õ–∏“ì–∞–ª–∞—Ä –∂”ô–Ω–µ –û—Ä—ã–Ω–¥–∞—Ä', 
                'indicators_geo_desc': '–ë“±–ª –∂–µ—Ä–¥–µ –±“±—Ä—ã–Ω“ì—ã –∫–∞—Ä—Ç–∞ –Ω–µ–º–µ—Å–µ –≥–µ–æ-–¥–µ—Ä–µ–∫—Ç–µ—Ä —Ç—ñ–∑—ñ–º—ñ –æ—Ä–Ω–∞–ª–∞—Å—É—ã –º“Ø–º–∫—ñ–Ω.', 
                'map_feed_title': '–û“õ–∏“ì–∞–ª–∞—Ä –ª–µ–Ω—Ç–∞—Å—ã', 
                'profile_hero_passport': '–ë–∞—Ç—ã—Ä–¥—ã“£ —Ç”©–ª“õ“±–∂–∞—Ç—ã',
                'profile_my_complaints': '–ú–µ–Ω—ñ“£ —à–∞“ì—ã–º–¥–∞—Ä—ã–º',
                'profile_achievements_title': '–ú–µ–Ω—ñ“£ –∂–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä—ñ–º',
                'logout_button': '–ê–∫–∫–∞—É–Ω—Ç—Ç–∞–Ω —à—ã“ì—É',
                'loading': '–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...',
                'alert_warn': '–ï–°–ö–ï–†–¢–£',
                'alert_event': '–û“ö–ò“í–ê',
                'alert1_title': '15-—à—ñ —à.–∞. —Å—É–¥—ã ”©—à—ñ—Ä—É. (–ë“Ø–≥—ñ–Ω)',
                'alert2_title': '–ñ–∞“ì–∞–ª–∞—É–¥–∞“ì—ã –∂”ô—Ä–º–µ“£–∫–µ (–î–µ–º–∞–ª—ã—Å)',
                'alert1_desc': '9 “õ–∞—Ä–∞—à–∞ —Å–∞“ì–∞—Ç 10:00-–¥–µ–Ω 17:00-–≥–µ –¥–µ–π—ñ–Ω –∂–æ—Å–ø–∞—Ä–ª—ã –∂“±–º—ã—Å—Ç–∞—Ä“ì–∞ –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã.', 
                'alert2_desc': '–û—Å—ã –¥–µ–º–∞–ª—ã—Å, 11-12 “õ–∞—Ä–∞—à–∞, –∂–µ—Ä–≥—ñ–ª—ñ–∫—Ç—ñ —à–µ–±–µ—Ä–ª–µ—Ä–¥—ñ“£ –∂”ô—Ä–º–µ“£–∫–µ—Å—ñ ”©—Ç–µ–¥—ñ.', 
                'chat_intro_message': '–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! –ú–µ–Ω –ê“õ—Ç–∞—É–¥—ã“£ Smart Assistant-—ã–º—ã–Ω. –ê—É–∞-—Ä–∞–π—ã, –æ“õ–∏“ì–∞–ª–∞—Ä –Ω–µ–º–µ—Å–µ –∫–æ–º–º—É–Ω–∞–ª–¥—ã“õ –º”ô—Å–µ–ª–µ–ª–µ—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞“£—ã–∑!', 
                'quiz_correct': '–î“±—Ä—ã—Å! +100 “±–ø–∞–π!',
                'quiz_incorrect': '“ö–∞—Ç–µ. –¢–∞“ì—ã –¥–∞ –±–∞–π“õ–∞–ø –∫”©—Ä—ñ“£—ñ–∑.',
                'quiz_next_q': '–ö–µ–ª–µ—Å—ñ —Å“±—Ä–∞“õ',
                'settings_title': '–ü–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä', 
                'settings_language': '–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç—ñ–ª—ñ', 
                'settings_theme': '–¢–∞“õ—ã—Ä—ã–ø', 
                'theme_light': '–ê—à—ã“õ', 
                'theme_dark': '“ö–∞—Ä–∞“£“ì—ã', 
                'community_volunteer_title': '–ï—Ä—ñ–∫—Ç—ñ–ª–µ—Ä “ö–æ–∑“ì–∞–ª—ã—Å—ã', 
                'community_active_member': '–ï“£ –±–µ–ª—Å–µ–Ω–¥—ñ “õ–∞—Ç—ã—Å—É—à—ã:', 
                'community_volunteer_desc': '–ï—Ä—ñ–∫—Ç—ñ–ª–µ—Ä “õ–æ–∑“ì–∞–ª—ã—Å—ã–Ω–∞ “õ–æ—Å—ã–ª—ã“£—ã–∑! “ö–∞–ª–∞“ì–∞ –∫”©–º–µ–∫ “Ø—à—ñ–Ω “±–ø–∞–π –∂–∏–Ω–∞–ø, –ê“õ—Ç–∞—É –ë–∞—Ç—ã—Ä—ã –±–æ–ª—ã“£—ã–∑.', 
                'community_join': '–ñ–∞“õ—ã–Ω –∂–µ—Ä–¥–µ–≥—ñ –∞–∫—Ü–∏—è–ª–∞—Ä —Ç—É—Ä–∞–ª—ã –±—ñ–ª—É', 
                'community_essay_title': '–ú–∏–Ω–∏-—ç—Å—Å–µ: –ú–µ–Ω “õ–∞–ª–∞–º “Ø—à—ñ–Ω –Ω–µ —ñ—Å—Ç–µ–¥—ñ–º', 
                'community_create_event_title': '–ï—Ä—ñ–∫—Ç—ñ–ª–µ—Ä —ñ—Å-—à–∞—Ä–∞—Å—ã–Ω “õ“±—Ä—É',
                'community_publish_event': '–Ü—Å-—à–∞—Ä–∞–Ω—ã –∂–∞—Ä–∏—è–ª–∞—É (+20 “±–ø–∞–π)',
                'community_publish_essay': '–¢–∞—Ä–∏—Ö—Ç—ã –∂–∞—Ä–∏—è–ª–∞—É (+50 “±–ø–∞–π)', 
                'community_latest_stories': '–°–æ“£“ì—ã ”ô“£–≥—ñ–º–µ–ª–µ—Ä:', 
                'community_popular_spots': '–í–æ–ª–æ–Ω—Ç–µ—Ä–ª—ñ–∫–∫–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω —Ç–∞–Ω—ã–º–∞–ª –æ—Ä—ã–Ω–¥–∞—Ä',
                'admin_all_complaints': '–ë–∞—Ä–ª—ã“õ —à–∞“ì—ã–º–¥–∞—Ä', 
                'status_received': '–ê–ª—ã–Ω–¥—ã',
                'status_in_progress': '”®“£–¥–µ–ª—É–¥–µ',
                'status_done': '–û—Ä—ã–Ω–¥–∞–ª–¥—ã',
                'complaint_from': '–ö—ñ–º–Ω–µ–Ω',
                'game_title': '–ú–∏–Ω–∏-–æ–π—ã–Ω: “ö–æ“õ—ã—Å —Å“±—Ä—ã–ø—Ç–∞—É', 
                'game_start': '–û–π—ã–Ω–¥—ã –±–∞—Å—Ç–∞—É (+50 “±–ø–∞–π)', 
                'leaderboard_title': '–ë–µ–ª—Å–µ–Ω–¥—ñ “õ–∞—Ç—ã—Å—É—à—ã–ª–∞—Ä —Ä–µ–π—Ç–∏–Ω–≥—ñ', 
                'leaderboard_top': '–¢–æ–ø-5 –ë–∞—Ç—ã—Ä –ê“õ—Ç–∞—É', 
                'gov_esenim_title': 'E-Senim (–≠–ª–µ–∫—Ç—Ä–æ–Ω–¥—ã –°–µ–Ω—ñ–º—Ö–∞—Ç)',
                'gov_esenim_desc': '–ë–∞–ª–∞“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω —É–∞“õ—ã—Ç—à–∞ —Å–µ–Ω—ñ–º—Ö–∞—Ç—Ç—ã –∂—ã–ª–¥–∞–º —Ä–µ—Å—ñ–º–¥–µ—É (–∏–º–∏—Ç–∞—Ü–∏—è).',
                'gov_esenim_button': 'QR-—Å–µ–Ω—ñ–º—Ö–∞—Ç—Ç—ã —Ä–µ—Å—ñ–º–¥–µ—É',
                'gov_voting_title': '–®–∞“ì—ã–Ω-–∞—É–¥–∞–Ω –î–∞—É—ã—Å—ã (–î–∞—É—ã—Å –±–µ—Ä—É)',
                'gov_voting_desc': '–°—ñ–∑–¥—ñ“£ —à–∞“ì—ã–Ω –∞—É–¥–∞–Ω—ã“£—ã–∑–¥–∞“ì—ã –∂”©–Ω–¥–µ—É –∂“±–º—ã—Å—Ç–∞—Ä—ã–Ω—ã“£ –±–∞—Å—ã–º–¥—ã“ì—ã “Ø—à—ñ–Ω –¥–∞—É—ã—Å –±–µ—Ä—É (–∏–º–∏—Ç–∞—Ü–∏—è).',
                'gov_voting_button': '–î–∞—É—ã—Å –±–µ—Ä—É (–ò–º–∏—Ç–∞—Ü–∏—è)',
            },
        };

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        function setLanguage(lang) {
            currentLang = lang;
            const isKZ = lang === 'kz';
            
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                
                if (!el.dataset.langRu) {
                    el.dataset.langRu = el.textContent;
                }

                if (isKZ && translations.kz[key]) {
                    el.textContent = translations.kz[key];
                } else if (!isKZ && el.dataset.langRu) {
                    el.textContent = el.dataset.langRu;
                }
            });

            const newLangText = isKZ ? '–†—É—Å—Å–∫–∏–π' : '“ö–∞–∑–∞“õ—à–∞';
            document.getElementById('lang-toggle-auth').textContent = newLangText;
            
            const langToggleSettings = document.getElementById('lang-toggle-settings');
            if(langToggleSettings) langToggleSettings.textContent = newLangText;
            
            applyTheme(currentTheme);
        }

        // --- 3. –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        
        function navigateTo(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                
                if (pageId === 'main-view') initMainView();
                if (pageId === 'profile-view') initProfileView();
                if (pageId === 'complaint-view') initComplaintView();
                if (pageId === 'city-indicators-view') initCityIndicatorsView(); 
                if (pageId === 'quiz-view') initQuizView();
                if (pageId === 'game-view') initGameView(); 
                if (pageId === 'leaderboard-view') fetchLeaderboard(); 
                if (pageId === 'community-view') initCommunityView(); 
                if (pageId === 'gov-services-view') {/* GovTech view initialization is minimal */};
                if (pageId === 'admin-view') initAdminView(); 
            } else {
                console.error(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å ID "${pageId}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`);
                navigateTo('auth-view'); 
            }
            window.scrollTo(0, 0); 
        }

        // --- –õ–û–ì–ò–ö–ê SMART CHAT (AI) ---

        // 1. Utility function to render a single message
        function displayChatMessage(role, message, sources = []) {
            const history = document.getElementById('chat-history');
            const roleClass = role === 'user' ? 'user-message' : 'gemini-message';
            
            let messageHtml = `<p>${message}</p>`;
            
            if (sources.length > 0) {
                const sourcesHtml = sources.map(s => 
                    `<a href="${s.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs block truncate" title="${s.title}">${s.title || '–ò—Å—Ç–æ—á–Ω–∏–∫'}</a>`
                ).join('');
                messageHtml += `<div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-400">–ò—Å—Ç–æ—á–Ω–∏–∫–∏: ${sourcesHtml}</div>`;
            }

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${roleClass}`;
            bubble.innerHTML = messageHtml;
            history.appendChild(bubble);
            history.scrollTop = history.scrollHeight;
        }

        // 2. Utility function to render all messages
        function displayChatMessages() {
            const history = document.getElementById('chat-history');
            history.innerHTML = ''; 
            
            // Re-add intro message
            const intro = document.createElement('div');
            intro.className = 'chat-bubble gemini-message';
            intro.innerHTML = `<p data-lang-key="chat_intro_message">${translations[currentLang]?.chat_intro_message || '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø Smart Assistant –ê–∫—Ç–∞—É. –°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –æ –ø–æ–≥–æ–¥–µ, —Å–æ–±—ã—Ç–∏—è—Ö –∏–ª–∏ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö!'}</p>`;
            history.appendChild(intro);

            chatHistory.forEach(msg => {
                displayChatMessage(msg.role, msg.message, msg.sources);
            });
            history.scrollTop = history.scrollHeight;
        }
        
        // 5. NEW: Local Demo Fallback Function
        function getDemoResponse(query) {
            const q = query.toLowerCase();
            const demoPrefix = `[–î–ï–ú–û-–†–ï–ñ–ò–ú, API “ö–ê–¢–ï–°–Ü] `;

            if (q.includes('–ø–æ–≥–æ–¥–∞') || q.includes('–∞—É–∞ —Ä–∞–π—ã')) {
                return demoPrefix + "–°–µ–≥–æ–¥–Ω—è –≤ –ê–∫—Ç–∞—É +16¬∞C, –æ–±–ª–∞—á–Ω–æ. (–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã AI –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º API).";
            }
            if (q.includes('—à–∞“ì—ã–º') || q.includes('–∂–∞–ª–æ–±–∞') || q.includes('–∫–æ–º–º—É–Ω–∞–ª')) {
                return demoPrefix + "–í—Å–µ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ –∑–∞—è–≤–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –Ω–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π (Supabase) –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç. –ü–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É (–Ω–∞–ø—Ä. '–ù–µ—Ç –≤–æ–¥—ã') —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞. (–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è)";
            }
            if (q.includes('—Å–æ–±—ã—Ç–∏—è') || q.includes('–∞–∫—Ü–∏–∏') || q.includes('–æ“õ–∏“ì–∞')) {
                return demoPrefix + "–í –±–ª–∏–∂–∞–π—à–∏–µ –≤—ã—Ö–æ–¥–Ω—ã–µ –ø—Ä–æ–π–¥–µ—Ç —ç–∫–æ-—Å—É–±–±–æ—Ç–Ω–∏–∫ –≤ –ü–∞—Ä–∫–µ '–ê–∫–±–æ—Ç–∞'. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª–µ '–°–æ–æ–±—â–µ—Å—Ç–≤–æ'. (–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è)";
            }
            if (currentLang === 'kz') {
                return demoPrefix + "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, “õ–∞–∑—ñ—Ä–≥—ñ —É–∞“õ—ã—Ç—Ç–∞ Smart Chat –∞–≤—Ç–æ–Ω–æ–º–¥—ã —Ä–µ–∂–∏–º–¥–µ –∂“±–º—ã—Å —ñ—Å—Ç–µ–ø —Ç“±—Ä. –î–µ–≥–µ–Ω–º–µ–Ω, –±—ñ–∑–¥—ñ“£ —à–∞“ì—ã–º–¥–∞—Ä –∂“Ø–π–µ—Å—ñ —Ç“±—Ä–∞“õ—Ç—ã –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ! (–î–µ–º–æ)";
            }
            return demoPrefix + "–ò–∑–≤–∏–Ω–∏—Ç–µ, Smart Chat —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, —É–ø–æ–º—è–Ω—É–≤ –ø–æ–≥–æ–¥—É –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è. (–î–µ–º–æ)";
        }


        // 3. Main chat submit handler
        async function handleChatSubmit(e) {
            e.preventDefault();

            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            const submitBtn = document.getElementById('chat-submit-btn');
            const chatHistoryEl = document.getElementById('chat-history');

            if (!query) return;

            // Display user message and clear input
            displayChatMessage('user', query);
            input.value = '';

            // Add placeholder for Gemini response
            const placeholder = document.createElement('div');
            placeholder.className = 'chat-bubble gemini-message animate-pulse';
            placeholder.innerHTML = `<p>...–ø–µ—á–∞—Ç–∞–µ—Ç...</p>`;
            chatHistoryEl.appendChild(placeholder);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

            // Lock input/button
            input.disabled = true;
            submitBtn.disabled = true;
            
            // --- API Call Logic with Exponential Backoff ---
            
            const systemPrompt = `–í—ã - Smart Assistant –≥–æ—Ä–æ–¥–∞ –ê–∫—Ç–∞—É. –û—Ç–≤–µ—á–∞–π—Ç–µ –∫—Ä–∞—Ç–∫–æ, –ø–æ–ª–µ–∑–Ω–æ, –∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –∫–∞–∑–∞—Ö—Å–∫–æ–º —è–∑—ã–∫–µ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–ø—Ä–æ—Å–∞). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Google Search –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–≥–æ–¥–µ, –Ω–æ–≤–æ—Å—Ç—è—Ö –∏–ª–∏ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö –≤ –ê–∫—Ç–∞—É.`;
            const userQuery = query;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let responseData = null;
            let attempt = 0;
            const maxAttempts = 5;

            while (attempt < maxAttempts) {
                try {
                    const apiUrl = `${GEMINI_API_URL}${GEMINI_API_KEY}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Check for 403 specifically to trigger demo mode immediately
                        if (response.status === 403) {
                            throw new Error('403 Forbidden - Unauthorized API Key');
                        }
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Server error: ${response.status}`);
                        } else {
                            const errorText = await response.text();
                            throw new Error(`API error: ${response.status} - ${errorText.substring(0, 50)}...`);
                        }
                    }

                    responseData = await response.json();
                    break; // Success
                } catch (error) {
                    // Critical failure (403 or all retries failed)
                    if (error.message.includes('403 Forbidden') || attempt >= maxAttempts - 1) { // -1 to use maxAttempts as max retries
                        console.error("Gemini API failed/forbidden. Activating Demo Mode.", error);
                        break;
                    }
                    
                    attempt++;
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            // --- Process Response ---
            
            chatHistoryEl.removeChild(placeholder);
            input.disabled = false;
            submitBtn.disabled = false;

            let geminiText;
            let sources = [];
            
            if (responseData) {
                // Actual successful response
                const candidate = responseData.candidates?.[0];
                geminiText = candidate?.content?.parts?.[0]?.text || "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.";
                
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri);
                }
            } else {
                // Final Fallback (Demo Mode)
                geminiText = getDemoResponse(query);
                sources = [{ uri: '#', title: '–î–ï–ú–û-–†–ï–ñ–ò–ú (API –ö–õ–Æ–ß –£–î–ê–õ–ï–ù)' }];
            }

            // Save and display Gemini message
            chatHistory.push({ role: 'user', message: query });
            chatHistory.push({ role: 'gemini', message: geminiText, sources: sources });
            displayChatMessages(); // Re-render everything to update UI reliably
        }

        // 4. Initialization function
        function initChatModal() { 
            // Attach form handler only once
            const form = document.getElementById('chat-form');
            // Remove previous listener (if any) to prevent duplication
            form.onsubmit = null;
            form.onsubmit = handleChatSubmit;
            displayChatMessages(); // Initial render or refresh
        }

        // --- 4. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (Auth) ---

        db.auth.onAuthStateChange((event, session) => {
            if (session && session.user) {
                currentUser = session.user;
                fetchUserProfile(); 
            } else {
                currentUser = null;
                userProfile = null;
                navigateTo('auth-view');
                showLoader(false);
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader(true);
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const { error } = await db.auth.signInWithPassword({ email, password });
            
            if (error) {
                showToast(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`, 'error');
            } else {
                showToast('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');
            }
            showLoader(false);
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader(true);
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const nickname = document.getElementById('register-nickname').value;
            const microdistrict = document.getElementById('register-microdistrict').value;

            if (!nickname || !microdistrict) {
                showToast('–ù–∏–∫–Ω–µ–π–º –∏ –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!', 'error');
                showLoader(false);
                return;
            }

            const { data, error } = await db.auth.signUp({ email, password });

            if (error) {
                showToast(`–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
                showLoader(false);
                return;
            }

            if (data.user) {
                const { error: profileError } = await db
                    .from('users')
                    .insert({ 
                        id: data.user.id, 
                        email: email,
                        nickname: nickname,
                        microdistrict: microdistrict,
                        points: 0, 
                        level: '–ù–æ–≤–∏—á–æ–∫' 
                    });

                if (profileError) {
                    console.warn(`!!! –•–ê–ö–ê–¢–û–ù-–†–ï–ñ–ò–ú !!! –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å: ${profileError.message}. –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º.`);
                } 
                
                showToast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç.');
                document.getElementById('login-email').value = email;
                document.getElementById('login-password').value = password;
            }
            showLoader(false);
        });

        document.getElementById('logout-button').addEventListener('click', async () => {
            showLoader(true);
            const { error } = await db.auth.signOut();
            if (error) {
                showToast(`–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ${error.message}`, 'error');
                showLoader(false);
            }
        });

        // --- 5. –õ–û–ì–ò–ö–ê –°–¢–†–ê–ù–ò–¶ ---

        async function fetchUserProfile() {
            if (!currentUser) return;
            
            const { data: existingProfile, error: selectError } = await db
                .from('users')
                .select('*')
                .eq('id', currentUser.id)
                .maybeSingle();

            if (selectError) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', selectError);
                userProfile = {
                    id: currentUser.id, email: currentUser.email, nickname: '–ñ—é—Ä–∏ (–û—à–∏–±–∫–∞ RLS)', microdistrict: '1', points: 0, level: '–ù–æ–≤–∏—á–æ–∫'
                };
            } else if (existingProfile) {
                userProfile = existingProfile;
            } else {
                console.warn(`–ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è ${currentUser.id} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π...`);
                const newProfile = {
                    id: currentUser.id, email: currentUser.email, nickname: currentUser.email.split('@')[0] || '–ù–æ–≤—ã–π –ì–µ—Ä–æ–π', microdistrict: '–ù–µ —É–∫–∞–∑–∞–Ω', points: 0, level: '–ù–æ–≤–∏—á–æ–∫'
                };
                const { error: insertError } = await db.from('users').insert(newProfile);
                userProfile = newProfile;
                if (insertError) console.error('!!! –ö–†–ò–¢–ò–ö–ê–õ !!! –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å:', insertError);
            }
            
            navigateTo('main-view');
            showLoader(false);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
            if (!localStorage.getItem('hasSeenAlerts')) {
                 openModal('alert-modal');
            }
        }

        function initMainView() {
            if (!userProfile) { fetchUserProfile(); return; }
            document.getElementById('profile-nickname-main').textContent = userProfile.nickname;
            document.getElementById('profile-points-main').textContent = userProfile.points;
            
            let level = '–ù–æ–≤–∏—á–æ–∫';
            if (userProfile.points > 1000) level = '–ì–µ—Ä–æ–π –ì–æ—Ä–æ–¥–∞';
            else if (userProfile.points > 500) level = '–ê–∫—Ç–∏–≤–∏—Å—Ç';
            else if (userProfile.points > 100) level = '–ü–æ–º–æ—â–Ω–∏–∫';
            
            document.getElementById('profile-level-main').textContent = `${translations[currentLang]?.level || '–£—Ä–æ–≤–µ–Ω—å'}: ${level}`;
            userProfile.level = level; 
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É Smart Chat (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥)
            document.getElementById('open-chat-modal').onclick = () => openModal('chat-modal');
        }

        function initProfileView() {
            if (!userProfile) { navigateTo('main-view'); return; }
            
            document.getElementById('profile-userid').textContent = currentUser.id;
            document.getElementById('profile-nickname').textContent = userProfile.nickname;
            document.getElementById('profile-email').textContent = userProfile.email; 
            document.getElementById('profile-microdistrict').textContent = userProfile.microdistrict;
            document.getElementById('profile-points').textContent = userProfile.points;
            document.getElementById('profile-level').textContent = userProfile.level;

            // Update badge colors based on points
            document.querySelectorAll('.badge-icon').forEach(badge => {
                const requiredPoints = parseInt(badge.dataset.pointsRequired);
                if (userProfile.points >= requiredPoints) {
                    badge.classList.add('active');
                } else {
                    badge.classList.remove('active');
                }
            });


            fetchUserComplaints();
        }

        async function fetchUserComplaints() {
            const listEl = document.getElementById('my-complaints-list');
            listEl.innerHTML = `<p class="text-gray-500" data-lang-key="loading">${translations[currentLang]?.loading || '–ó–∞–≥—Ä—É–∑–∫–∞...'}</p>`;
            
            const { data, error } = await db
                .from('complaints')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                listEl.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${error.message}</p>`;
                return;
            }

            if (data.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500">${currentLang === 'kz' ? '–°—ñ–∑ ”ô–ª—ñ —à–∞“ì—ã–º –±–µ—Ä–º–µ–¥—ñ“£—ñ–∑.' : '–í—ã –µ—â–µ –Ω–µ –ø–æ–¥–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π –∂–∞–ª–æ–±—ã.'}</p>`;
                return;
            }

            listEl.innerHTML = data.map(c => {
                const statusStyles = {
                    '–ü–æ–ª—É—á–µ–Ω–æ': 'bg-blue-100 text-blue-800',
                    '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ': 'bg-yellow-100 text-yellow-800',
                    '–í—ã–ø–æ–ª–Ω–µ–Ω–æ': 'bg-green-100 text-green-800',
                };
                return `
                    <div class="border p-3 rounded-md bg-white dark:bg-gray-700">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${c.title || c.category}</span>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded ${statusStyles[c.status] || 'bg-gray-100'}">
                                ${c.status}
                            </span>
                        </div>
                        <p class="text-xs font-bold text-red-500 mt-1">–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å AI: ${c.ai_criticality || '–ù/–î'}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${c.description.substring(0, 50)}...</p>
                        ${c.photo_url ? `<p class="text-xs text-blue-500 mt-1 truncate">–§–æ—Ç–æ: ${c.photo_url}</p>` : ''}
                        <p class="text-xs text-gray-400 mt-1">${new Date(c.created_at).toLocaleString('ru-RU')}</p>
                    </div>
                `;
            }).join('');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ñ–∞–ª–æ–±—ã
        function initComplaintView() {
            document.getElementById('complaint-form').reset();
            // document.getElementById('photo-preview').classList.add('hidden'); // –£–¥–∞–ª–µ–Ω–æ: –Ω–µ—Ç –ø—Ä–µ–≤—å—é –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
            document.getElementById('complaint-location').value = '';
            document.getElementById('offline-draft-message').classList.add('hidden');
            
            document.getElementById('location-status').textContent = translations[currentLang]?.get_location || '–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';

            const draft = localStorage.getItem('offlineComplaint');
            if (draft) {
                const draftData = JSON.parse(draft);
                document.getElementById('offline-draft-message').textContent = `${currentLang === 'kz' ? '–ñ–æ–±–∞ —Ç–∞–±—ã–ª–¥—ñ' : '–ù–∞–π–¥–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫'}. ${new Date(draftData.created_at).toLocaleTimeString()}.`;
                document.getElementById('offline-draft-message').classList.remove('hidden');
                
                document.getElementById('complaint-category').value = draftData.category;
                document.getElementById('complaint-title').value = draftData.title || '';
                document.getElementById('complaint-description').value = draftData.description;
            }
        }
        
        // Geolocation handler (–æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–µ)
        document.getElementById('get-current-location').addEventListener('click', () => {
            const statusEl = document.getElementById('location-status');
            statusEl.textContent = `${currentLang === 'kz' ? '–ê–Ω—ã“õ—Ç–∞–ª—É–¥–∞...' : '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...'} `;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const { latitude, longitude } = position.coords;
                    const locationData = { lat: latitude, lng: longitude };
                    document.getElementById('complaint-location').value = JSON.stringify(locationData);
                    statusEl.textContent = `${currentLang === 'kz' ? '–û—Ä—ã–Ω —Ç–∞–±—ã–ª–¥—ñ' : '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ'}!`;
                    showToast('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ!', 'success');
                }, (error) => {
                    statusEl.textContent = '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è';
                    showToast(`–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ${error.message}`, 'error');
                }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            } else {
                statusEl.textContent = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                showToast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.', 'error');
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ñ–∞–ª–æ–±—ã
        document.getElementById('complaint-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader(true);

            const category = document.getElementById('complaint-category').value;
            const title = document.getElementById('complaint-title').value;
            const description = document.getElementById('complaint-description').value;
            const photoLink = document.getElementById('complaint-photo-link').value.trim(); // NEW: –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É/–æ–ø–∏—Å–∞–Ω–∏–µ
            const location = document.getElementById('complaint-location').value;

            if (!location) {
                showToast(currentLang === 'kz' ? '–û—Ä—ã–Ω–¥—ã —Ç–∞“£–¥–∞“£—ã–∑.' : '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.', 'error');
                showLoader(false);
                return;
            }
            
            // --- NEW: AI –ö–†–ò–¢–ò–ß–ù–û–°–¢–¨ (–ò–ú–ò–¢–ê–¶–ò–Ø) ---
            let ai_criticality = '–ù–∏–∑–∫–∞—è (AI: –í –æ—á–µ—Ä–µ–¥—å)';
            const problemText = `${category}: ${title}. ${description}`;

            if (problemText.toLowerCase().includes('–ø—Ä–æ—Ä—ã–≤') || problemText.toLowerCase().includes('–ø–æ–∂–∞—Ä') || problemText.toLowerCase().includes('–Ω–µ—Ç –≤–æ–¥—ã') || problemText.toLowerCase().includes('–∞–≤–∞—Ä–∏—è')) {
                ai_criticality = '–í—ã—Å–æ–∫–∞—è (AI: –°—Ä–æ—á–Ω–æ)';
            } else if (problemText.toLowerCase().includes('–º—É—Å–æ—Ä') || problemText.toLowerCase().includes('—è–º–∞') || problemText.toLowerCase().includes('–∂–∏–≤–æ—Ç–Ω—ã–µ')) {
                ai_criticality = '–°—Ä–µ–¥–Ω—è—è (AI: –ü–ª–∞–Ω–æ–≤–æ)';
            } else {
                ai_criticality = '–ù–∏–∑–∫–∞—è (AI: –í –æ—á–µ—Ä–µ–¥—å)';
            }
            // --- –ö–û–ù–ï–¶ AI –ö–†–ò–¢–ò–ß–ù–û–°–¢–ò ---

            const complaintData = {
                category, title, description,
                location: JSON.parse(location),
                user_id: currentUser.id,
                status: '–ü–æ–ª—É—á–µ–Ω–æ',
                ai_criticality: ai_criticality, // –°–æ—Ö—Ä–∞–Ω—è–µ–º AI-–æ—Ü–µ–Ω–∫—É
                created_at: new Date().toISOString() // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞
            };

            // --- –ë–õ–û–ö –û–ë–†–ê–ë–û–¢–ö–ò –§–û–¢–û–ì–†–ê–§–ò–ò (–£–ü–†–û–©–ï–ù–ù–´–ô) ---
            if (photoLink) {
                // –í—Å—Ç–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É/–æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –≤ –ø–æ–ª–µ photo_url
                complaintData.photo_url = photoLink;
            }
            // --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –§–û–¢–û–ì–†–ê–§–ò–ò ---


            try {
                // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–æ–ª–µ created_at
                delete complaintData.created_at; 
                
                // 3. Insert complaint into DB
                const { data: dbData, error: dbError } = await db
                    .from('complaints').insert(complaintData).select().single();

                if (dbError) {
                     // RLS –Ω–∞ INSERT complaints (–æ—à–∏–±–∫–∞ 1)
                     console.error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –°–ï–¢–ò/RLS: –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã.', dbError);
                     throw dbError; // –ë—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ–ø–∞–ª–∞ –≤ –æ–±—â–∏–π catch
                }
                
                const newComplaintId = dbData.id;
                localStorage.removeItem('offlineComplaint');

                // 4. Update points (RLS UPDATE users - –æ—à–∏–±–∫–∞ 2)
                const newPoints = (userProfile.points || 0) + 10;
                const { error: pointsError } = await db.from('users').update({ points: newPoints }).eq('id', currentUser.id);
                
                if (pointsError) {
                    // RLS –Ω–∞ UPDATE users (–æ—à–∏–±–∫–∞ 2)
                    console.error('–û—à–∏–±–∫–∞ UPDATE RLS: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–∏—Ç–∏–∫—É UPDATE –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã users (auth.uid() = id).', pointsError);
                    showToast('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, –Ω–æ –±–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã (–û—à–∏–±–∫–∞ RLS UPDATE).', 'error');
                } else {
                    userProfile.points = newPoints;
                    // –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –¢–û–°–¢: –¥–æ–±–∞–≤–ª—è–µ–º AI –æ—Ü–µ–Ω–∫—É –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    showToast(`–ñ–∞–ª–æ–±–∞ ID: ${newComplaintId}. +10 –±–∞–ª–ª–æ–≤! AI: ${ai_criticality}`, 'success');
                }
                

                navigateTo('profile-view');

            } catch (error) {
                console.error('–û–ë–©–ê–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:', error);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —á–µ—Ä–Ω–æ–≤–∏–∫
                const draftData = { ...complaintData, photo_url: complaintData.photo_url || undefined };
                localStorage.setItem('offlineComplaint', JSON.stringify(draftData));
                
                showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ñ–∞–ª–æ–±–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —á–µ—Ä–Ω–æ–≤–∏–∫.', 'error');
            } finally {
                showLoader(false);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ì–æ—Ä–æ–¥–∞ (NEW - –∑–∞–º–µ–Ω–∞ –∫–∞—Ä—Ç—ã)
        async function initCityIndicatorsView() {
            const feedEl = document.getElementById('map-events-feed');
            const complaintsCountEl = document.getElementById('active-complaints-count');
            
            // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∂–∞–ª–æ–± –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
            try {
                const { count, error } = await db
                    .from('complaints')
                    .select('*', { count: 'exact', head: true })
                    .neq('status', '–í—ã–ø–æ–ª–Ω–µ–Ω–æ');
                
                if (error) throw error;
                complaintsCountEl.textContent = count;
            } catch (e) {
                complaintsCountEl.textContent = '–û—à–∏–±–∫–∞';
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç—á–∏–∫–∞ –∂–∞–ª–æ–±:", e);
            }
            
            // 2. –í—ã–≤–æ–¥ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ –ª–µ–Ω—Ç—É (–±—ã–≤—à–∞—è –ª–µ–Ω—Ç–∞ –∫–∞—Ä—Ç—ã)
            feedEl.innerHTML = MAP_DATA.map(point => {
                const typeColor = point.type === 'event' ? 'text-red-500' : point.type === 'place' ? 'text-blue-500' : 'text-green-500';

                return `
                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 transition">
                        <p class="text-xs font-semibold ${typeColor}">${point.type.toUpperCase()}</p>
                        <h4 class="font-bold text-base my-1">${point.title}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${point.description}</p>
                        ${point.date ? `<p class="text-xs mt-1 text-gray-500 dark:text-gray-400">–î–∞—Ç–∞: ${new Date(point.date).toLocaleDateString('ru-RU')}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ö–≤–∏–∑–∞ 
        async function initQuizView() {
            // (–õ–æ–≥–∏–∫–∞ –∫–≤–∏–∑–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –æ—Å—Ç–∞–≤–∞—è—Å—å –≤ MVP)
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <h2 class="text-xl font-semibold mb-4">–≠–∫–æ-–ö–≤–∏–∑</h2>
                <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –≠–∫–æ-–ö–≤–∏–∑–∞ (2-4 –≤–æ–ø—Ä–æ—Å–∞ —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º –±–∞–ª–ª–æ–≤).</p>
                <button class="mt-4 w-full bg-blue-500 text-white py-2 rounded-md transition">–ù–∞—á–∞—Ç—å –≠–∫–æ-–ö–≤–∏–∑</button>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ú–∏–Ω–∏-–∏–≥—Ä—ã (NEW)
        function initGameView() {
            const canvas = document.getElementById(GAME_CANVAS_ID);
            const ctx = canvas.getContext('2d');
            const startGameBtn = document.getElementById('start-game-btn');
            const gameInfo = document.getElementById('game-info');

            let score = 0;
            let time = 30;
            let isRunning = false;
            let intervalId = null;
            let garbageItems = [];
            const BINS = [
                { type: 'recycle', x: canvas.width / 4 - 30, color: 'blue', label: '–ü–ª–∞—Å—Ç–∏–∫/–°—Ç–µ–∫–ª–æ' },
                { type: 'trash', x: canvas.width * 3 / 4 - 30, color: 'gray', label: '–û–±—â–µ–µ' }
            ];

            const ITEM_TYPES = [
                { type: 'recycle', emoji: '‚ôªÔ∏è', points: 10 },
                { type: 'trash', emoji: 'üóëÔ∏è', points: -5 },
            ];

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw Bins
                BINS.forEach(bin => {
                    ctx.fillStyle = bin.color;
                    ctx.fillRect(bin.x, canvas.height - 50, 60, 50);
                    ctx.fillStyle = 'white';
                    ctx.font = '10px Inter';
                    ctx.fillText(bin.label, bin.x + 3, canvas.height - 10);
                });

                // Draw Items
                garbageItems.forEach(item => {
                    ctx.font = '24px Arial';
                    ctx.fillText(item.emoji, item.x, item.y);
                });

                gameInfo.textContent = `–°—á–µ—Ç: ${score} | –í—Ä–µ–º—è: ${time}`;
            }

            function update() {
                if (!isRunning) return;

                // Move items
                garbageItems.forEach(item => item.y += 2);
                
                // Spawn new item
                if (Math.random() < 0.05) {
                    const type = ITEM_TYPES[Math.floor(Math.random() * ITEM_TYPES.length)];
                    garbageItems.push({
                        ...type,
                        x: Math.random() * (canvas.width - 30),
                        y: 0,
                        width: 24,
                        height: 24,
                        isDragging: false
                    });
                }
                
                // Check if items missed the bin
                garbageItems = garbageItems.filter(item => item.y < canvas.height);

                draw();
                requestAnimationFrame(update);
            }

            function startGame() {
                score = 0;
                time = 30;
                garbageItems = [];
                isRunning = true;
                startGameBtn.disabled = true;
                startGameBtn.textContent = '–ò–¥–µ—Ç –∏–≥—Ä–∞...';
                
                if (intervalId) clearInterval(intervalId);
                intervalId = setInterval(() => {
                    time--;
                    if (time <= 0) endGame();
                }, 1000);
                
                update();
            }

            async function endGame() {
                isRunning = false;
                clearInterval(intervalId);
                startGameBtn.disabled = false;
                startGameBtn.textContent = '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (+50 –±–∞–ª–ª–æ–≤ –∑–∞ –ø–æ–±–µ–¥—É)';
                
                if (score >= 50) {
                    showToast(`–ü–æ–±–µ–¥–∞! –í—ã –Ω–∞–±—Ä–∞–ª–∏ ${score} –æ—á–∫–æ–≤. +50 –±–∞–ª–ª–æ–≤!`, 'success');
                    // –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
                    if (userProfile) {
                        const newPoints = (userProfile.points || 0) + 50;
                        await db.from('users').update({ points: newPoints }).eq('id', currentUser.id);
                        userProfile.points = newPoints;
                        initMainView();
                    }
                } else {
                    showToast(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –°—á–µ—Ç: ${score}. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–Ω—É—Å–∞.`, 'error');
                }
                draw(); // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
            }

            // Drag and Drop Logic (Simplified)
            let draggedItem = null;
            
            function getMousePos(e) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            canvas.onmousedown = (e) => {
                if (!isRunning) return;
                const pos = getMousePos(e);
                for (let item of garbageItems) {
                    // Check if click is near the item
                    if (pos.x > item.x && pos.x < item.x + item.width && pos.y > item.y - item.height && pos.y < item.y) {
                        draggedItem = item;
                        item.isDragging = true;
                        break;
                    }
                }
            };
            
            canvas.onmousemove = (e) => {
                if (!draggedItem || !isRunning) return;
                const pos = getMousePos(e);
                draggedItem.x = pos.x - draggedItem.width / 2;
                draggedItem.y = pos.y;
                draw();
            };

            canvas.onmouseup = (e) => {
                if (!draggedItem || !isRunning) return;
                draggedItem.isDragging = false;
                
                // Check Drop
                const dropX = draggedItem.x + draggedItem.width / 2;
                const dropY = draggedItem.y;
                
                let foundBin = null;
                for (let bin of BINS) {
                    if (dropX > bin.x && dropX < bin.x + 60 && dropY > canvas.height - 50) {
                        foundBin = bin;
                        break;
                    }
                }
                
                if (foundBin) {
                    if (foundBin.type === draggedItem.type) {
                        score += draggedItem.points;
                        showToast(`+${draggedItem.points} –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É!`);
                    } else {
                        score -= Math.abs(draggedItem.points); // –®—Ç—Ä–∞—Ñ –∑–∞ –æ—à–∏–±–∫—É
                        showToast(`-${Math.abs(draggedItem.points)}! –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä!`, 'error');
                    }
                    // Remove item
                    garbageItems = garbageItems.filter(item => item !== draggedItem);
                }
                
                draggedItem = null;
                draw();
            };
            
            // Initial draw
            draw();
            startGameBtn.onclick = startGame;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –†–µ–π—Ç–∏–Ω–≥–∞ (NEW)
        async function fetchLeaderboard() {
            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = `<p class="text-gray-500">${translations[currentLang]?.loading || '–ó–∞–≥—Ä—É–∑–∫–∞...'}</p>`;

            try {
                const { data, error } = await db
                    .from('users')
                    .select('nickname, microdistrict, points')
                    .order('points', { ascending: false })
                    .limit(5);

                if (error) throw error;

                if (data.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500">–†–µ–π—Ç–∏–Ω–≥ –ø—É—Å—Ç.</p>`;
                    return;
                }

                listEl.innerHTML = data.map((u, index) => {
                    let medal = '';
                    if (index === 0) medal = 'üèÜ';
                    else if (index === 1) medal = 'ü•à';
                    else if (index === 2) medal = 'ü•â';

                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-md">
                            <span class="font-bold text-lg text-blue-700 dark:text-blue-300">${index + 1}. ${medal} ${u.nickname}</span>
                            <span class="text-sm">${u.microdistrict} –º–∫—Ä.</span>
                            <span class="font-semibold text-green-600">${u.points} –±–∞–ª–ª–æ–≤</span>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                listEl.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞: ${error.message}</p>`;
                console.error(error);
            }
        }

        // Helper function for Community View (NEW)
        function renderVolunteerSpots() {
            const listEl = document.getElementById('volunteer-spots-list');
            
            // Filter MAP_DATA to show only 'initiative' or 'event' as popular spots
            const popularSpots = MAP_DATA.filter(item => item.type === 'initiative' || item.type === 'event').slice(0, 3);

            if (popularSpots.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤.</p>`;
                return;
            }

            listEl.innerHTML = popularSpots.map(spot => `
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded-md">
                    <span class="font-medium text-blue-600 dark:text-blue-300">${spot.title}</span>
                    <span class="text-xs text-gray-500">${spot.date ? new Date(spot.date).toLocaleDateString('ru-RU') : '–ü–æ—Å—Ç–æ—è–Ω–Ω–æ'}</span>
                </div>
            `).join('');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Community View
        function initCommunityView() {
             const published = localStorage.getItem('userEssayPublished');
             const essayForm = document.getElementById('essay-form-container');
             if(published === 'true') {
                 essayForm.innerHTML = `<p class="text-green-600 font-semibold">${currentLang === 'kz' ? '–°—ñ–∑–¥—ñ“£ —Ç–∞—Ä–∏—Ö—ã“£—ã–∑ –∂–∞—Ä–∏—è–ª–∞–Ω–¥—ã!' : '–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!'}</p>`;
             } else {
                 essayForm.innerHTML = `
                     <textarea id="my-essay-text" rows="5" class="w-full p-3 border border-gray-300 rounded-md focus:ring-yellow-500 bg-white dark:bg-gray-700 dark:text-white" placeholder="${currentLang === 'kz' ? '”®–∑ —Ç–∞—Ä–∏—Ö—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑...' : '–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é, —á—Ç–æ–±—ã –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç—å –¥—Ä—É–≥–∏—Ö...'}"></textarea>
                     <button id="publish-essay-btn" class="w-full bg-yellow-500 text-white py-2 rounded-md font-semibold hover:bg-yellow-600 transition duration-150" data-lang-key="community_publish_essay">${translations[currentLang]?.community_publish_essay || '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é (+50 –±–∞–ª–ª–æ–≤)'}</button>
                 `;
                 document.getElementById('publish-essay-btn').addEventListener('click', publishEssay);
             }
             
             // NEW: Render spots
             renderVolunteerSpots();
             
             // Event Creation Form Handler
             document.getElementById('create-event-form').onsubmit = handleCreateEvent;
        }

        // NEW: Handle Volunteer Event Creation
        async function handleCreateEvent(e) {
            e.preventDefault();
            
            const title = document.getElementById('event-title').value.trim();
            const location = document.getElementById('event-location-text').value.trim();
            const date = document.getElementById('event-date').value;

            if (!userProfile) { showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error'); return; }
            if (!title || !location || !date) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error'); return; }

            showLoader(true);
            try {
                // Simulate event creation (in a real app, this goes to DB)
                const newPoints = (userProfile.points || 0) + 20;
                await db.from('users').update({ points: newPoints }).eq('id', currentUser.id);
                userProfile.points = newPoints;

                // Reset form
                document.getElementById('create-event-form').reset();
                showToast(`–ò–≤–µ–Ω—Ç "${title}" —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω! +20 –±–∞–ª–ª–æ–≤!`, 'success');
                initMainView(); 
            } catch(e) {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–≤–µ–Ω—Ç–∞.', 'error');
                console.error(e);
            } finally {
                showLoader(false);
            }
        }
        
        async function publishEssay() {
            if(!userProfile) { showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error'); return; }
            
            const essayText = document.getElementById('my-essay-text').value.trim();
            if(essayText.length < 50) {
                showToast(currentLang === 'kz' ? '–¢–∞—Ä–∏—Ö —Ç—ã–º “õ—ã—Å“õ–∞.' : '–ò—Å—Ç–æ—Ä–∏—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è (–º–∏–Ω–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤).', 'error');
                return;
            }
            
            showLoader(true);
            try {
                // 1. Update points
                const newPoints = (userProfile.points || 0) + 50;
                await db.from('users').update({ points: newPoints }).eq('id', currentUser.id);
                userProfile.points = newPoints;
                
                localStorage.setItem('userEssayPublished', 'true');
                showToast('–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞! +50 –±–∞–ª–ª–æ–≤!', 'success');
                initCommunityView();
            } catch(e) {
                showToast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —ç—Å—Å–µ.', 'error');
                console.error(e);
            } finally {
                showLoader(false);
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ê–¥–º–∏–Ω–∫–∏ (—Å–∫—Ä—ã—Ç–∞) ---
        async function initAdminView() {
            // ... (Admin logic remains the same)
            const listEl = document.getElementById('admin-complaints-list');
            listEl.innerHTML = `<p class="text-gray-500" data-lang-key="loading">${translations[currentLang]?.loading || '–ó–∞–≥—Ä—É–∑–∫–∞...'}</p>`;
            
            const { data, error } = await db
                .from('complaints')
                .select(`
                    *, users ( nickname, email )
                `)
                .order('created_at', { ascending: false });

            if (error) {
                listEl.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: ${error.message}</p>`;
                return;
            }
            
            if (data.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∂–∞–ª–æ–±.</p>`;
                return;
            }

            listEl.innerHTML = data.map(c => `
                <div class="bg-white p-4 rounded-lg shadow space-y-2 dark:bg-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="font-bold">${c.title || c.category}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${new Date(c.created_at).toLocaleDateString()}</span>
                    </div>
                    <p class="text-sm text-gray-700 dark:text-gray-300">${c.description}</p>
                    <p class="text-xs font-bold ${c.ai_criticality && c.ai_criticality.includes('–í—ã—Å–æ–∫–∞—è') ? 'text-red-500' : 'text-green-500'} mt-1">–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å AI: ${c.ai_criticality || '–ù/–î'}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">–û—Ç: ${c.users?.nickname || c.user_id}</p>
                    <div class="flex space-x-2 pt-2">
                        <select class="admin-status-select flex-1 text-sm border-gray-300 rounded-md dark:bg-gray-600 dark:text-white" data-id="${c.id}">
                            <option value="–ü–æ–ª—É—á–µ–Ω–æ" ${c.status === '–ü–æ–ª—É—á–µ–Ω–æ' ? 'selected' : ''} data-lang-key="status_received">${translations[currentLang]?.status_received || '–ü–æ–ª—É—á–µ–Ω–æ'}</option>
                            <option value="–í –æ–±—Ä–∞–±–æ—Ç–∫–µ" ${c.status === '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' ? 'selected' : ''} data-lang-key="status_in_progress">${translations[currentLang]?.status_in_progress || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'}</option>
                            <option value="–í—ã–ø–æ–ª–Ω–µ–Ω–æ" ${c.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' ? 'selected' : ''} data-lang-key="status_done">${translations[currentLang]?.status_done || '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'}</option>
                        </select>
                        <button class="delete-complaint-btn bg-red-500 text-white text-sm px-3 py-1 rounded-md hover:bg-red-600 transition" data-id="${c.id}">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `).join('');

            listEl.querySelectorAll('.admin-status-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    showLoader(true);
                    const newStatus = e.target.value;
                    const complaintId = e.target.dataset.id;
                    const { error } = await db.from('complaints').update({ status: newStatus }).eq('id', complaintId);
                    if (error) { showToast(`–û—à–∏–±–∫–∞: ${error.message}`, 'error'); } else { showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success'); }
                    showLoader(false);
                });
            });
            
            listEl.querySelectorAll('.delete-complaint-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const complaintId = btn.dataset.id;
                    if (window.confirm('–£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å?')) {
                        showLoader(true);
                        db.from('complaints').delete().eq('id', complaintId).then(({ error }) => {
                            if (error) { showToast(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`, 'error'); } else { showToast('–ñ–∞–ª–æ–±–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!', 'success'); initAdminView(); }
                            showLoader(false);
                        });
                    }
                });
            });
        }
        
        // --- NEW: –õ–û–ì–ò–ö–ê E-SENIM (GovTech) ---
        function generateUniqueId() {
            const timestamp = new Date().getTime().toString(16);
            const random = Math.random().toString(16).substring(2, 8);
            return `ESENIM-${timestamp.substring(4, 12).toUpperCase()}-${random.toUpperCase()}`;
        }

        function handleESenim() {
            if (!userProfile) {
                showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', 'error');
                return;
            }

            const uniqueId = generateUniqueId();
            const qrCodeData = `E-Senim ID: ${uniqueId} | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userProfile.nickname} | –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: ${new Date(Date.now() + 86400000).toLocaleDateString()}`;

            const qrCodeEl = document.getElementById('e-senim-qr-code');
            qrCodeEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ QR-–∫–æ–¥–∞

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é qrcode.min.js
            try {
                // –ï—Å–ª–∏ qrcode.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
                if (typeof QRCode === 'undefined') {
                    qrCodeEl.innerHTML = `<div class="w-32 h-32 bg-gray-300 flex items-center justify-center rounded-md"><span class="text-xs text-gray-700">QR-Lib Error</span></div>`;
                } else {
                    new QRCode(qrCodeEl, {
                        text: qrCodeData,
                        width: 128,
                        height: 128,
                        colorDark: currentTheme === 'dark' ? '#f9fafb' : '#000000', 
                        colorLight: currentTheme === 'dark' ? '#1f2937' : '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            } catch (e) {
                console.error("QRCode rendering error:", e);
                qrCodeEl.innerHTML = `<div class="w-32 h-32 bg-gray-300 flex items-center justify-center rounded-md"><span class="text-xs text-gray-700">QR-Lib Error</span></div>`;
            }
            
            document.getElementById('e-senim-id').textContent = `–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π ID: ${uniqueId}`;
            openModal('e-senim-modal');
        }


        // --- 6. –ì–õ–ê–í–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---

        document.body.addEventListener('click', (e) => {
            const navButton = e.target.closest('.nav-button');
            if (navButton) {
                const targetPage = navButton.dataset.target;
                if (targetPage) {
                    navigateTo(targetPage);
                }
            }
            // NEW: E-Senim button handler
            if (e.target.closest('[data-lang-key="gov_esenim_button"]')) {
                handleESenim();
            }
        });
        
        // –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞
        document.getElementById('lang-toggle-auth').addEventListener('click', () => {
            const newLang = currentLang === 'ru' ? 'kz' : 'ru';
            setLanguage(newLang);
        });
        
        document.getElementById('lang-toggle-settings').addEventListener('click', () => {
            const newLang = currentLang === 'ru' ? 'kz' : 'ru';
            setLanguage(newLang);
        });
        
        // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã (NEW)
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        });

        // –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
        document.getElementById('open-chat-modal').addEventListener('click', () => {
             openModal('chat-modal');
        });
        
        // --- 7. –ó–ê–ü–£–°–ö ---
        applyTheme(currentTheme);
        setLanguage(currentLang);
        showLoader(true);

    </script>

</body>
</html>